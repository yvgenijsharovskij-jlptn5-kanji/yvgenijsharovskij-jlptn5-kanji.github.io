THREE.VREffect=function(e,t){function i(){var t=c.isPresenting;if(c.isPresenting=void 0!==s&&s.isPresenting,c.isPresenting){var i=s.getEyeParameters("left"),r=i.renderWidth,n=i.renderHeight;t||(m=e.getPixelRatio(),f=e.getSize(),e.setPixelRatio(1),e.setSize(2*r,n,!1))}else t&&(e.setPixelRatio(m),e.setSize(f.width,f.height,w))}function r(e){var t=2/(e.leftTan+e.rightTan),i=(e.leftTan-e.rightTan)*t*.5,r=2/(e.upTan+e.downTan);return{scale:[t,r],offset:[i,(e.upTan-e.downTan)*r*.5]}}function n(e,t,i,n){t=void 0===t||t,i=void 0===i?.01:i,n=void 0===n?1e4:n;var a=t?-1:1,s=new THREE.Matrix4,o=s.elements,h=r(e);return o[0]=h.scale[0],o[1]=0,o[2]=h.offset[0]*a,o[3]=0,o[4]=0,o[5]=h.scale[1],o[6]=-h.offset[1]*a,o[7]=0,o[8]=0,o[9]=0,o[10]=n/(i-n)*-a,o[11]=n*i/(i-n),o[12]=0,o[13]=0,o[14]=a,o[15]=0,s.transpose(),s}function a(e,t,i,r){var a=Math.PI/180;return n({upTan:Math.tan(e.upDegrees*a),downTan:Math.tan(e.downDegrees*a),leftTan:Math.tan(e.leftDegrees*a),rightTan:Math.tan(e.rightDegrees*a)},t,i,r)}var s,o,h,d,l=new THREE.Vector3,u=new THREE.Vector3,g=null;"VRFrameData"in window&&(g=new window.VRFrameData),navigator.getVRDisplays&&navigator.getVRDisplays().then(function(e){o=e,e.length>0?s=e[0]:t&&t("HMD not available")}).catch(function(){console.warn("THREE.VREffect: Unable to get VR Displays")}),this.isPresenting=!1,this.scale=1;var c=this,f=e.getSize(),w=!1,m=e.getPixelRatio();this.getVRDisplay=function(){return s},this.setVRDisplay=function(e){s=e},this.getVRDisplays=function(){return console.warn("THREE.VREffect: getVRDisplays() is being deprecated."),o},this.setSize=function(t,i,r){if(f={width:t,height:i},w=r,c.isPresenting){var n=s.getEyeParameters("left");e.setPixelRatio(1),e.setSize(2*n.renderWidth,n.renderHeight,!1)}else e.setPixelRatio(m),e.setSize(t,i,r)};var p=e.domElement,v=[0,0,.5,1],y=[.5,0,.5,1];window.addEventListener("vrdisplaypresentchange",i,!1),this.setFullScreen=function(e){return new Promise(function(t,i){void 0!==s?c.isPresenting!==e?t(e?s.requestPresent([{source:p}]):s.exitPresent()):t():i(new Error("No VR hardware found."))})},this.requestPresent=function(){return this.setFullScreen(!0)},this.exitPresent=function(){return this.setFullScreen(!1)},this.requestAnimationFrame=function(e){return void 0!==s?s.requestAnimationFrame(e):window.requestAnimationFrame(e)},this.cancelAnimationFrame=function(e){void 0!==s?s.cancelAnimationFrame(e):window.cancelAnimationFrame(e)},this.submitFrame=function(){void 0!==s&&c.isPresenting&&s.submitFrame()},this.autoSubmitFrame=!0;var R=new THREE.PerspectiveCamera;R.layers.enable(1);var x=new THREE.PerspectiveCamera;x.layers.enable(2),this.render=function(t,i,r,n){if(s&&c.isPresenting){var o=t.autoUpdate;o&&(t.updateMatrixWorld(),t.autoUpdate=!1);var f=s.getEyeParameters("left"),w=s.getEyeParameters("right");l.fromArray(f.offset),u.fromArray(w.offset),Array.isArray(t)&&(console.warn("THREE.VREffect.render() no longer supports arrays. Use object.layers instead."),t=t[0]);var m,p,E=e.getSize(),P=s.getLayers();if(P.length){var T=P[0];m=null!==T.leftBounds&&4===T.leftBounds.length?T.leftBounds:v,p=null!==T.rightBounds&&4===T.rightBounds.length?T.rightBounds:y}else m=v,p=y;h={x:Math.round(E.width*m[0]),y:Math.round(E.height*m[1]),width:Math.round(E.width*m[2]),height:Math.round(E.height*m[3])},d={x:Math.round(E.width*p[0]),y:Math.round(E.height*p[1]),width:Math.round(E.width*p[2]),height:Math.round(E.height*p[3])},r?(e.setRenderTarget(r),r.scissorTest=!0):(e.setRenderTarget(null),e.setScissorTest(!0)),(e.autoClear||n)&&e.clear(),null===i.parent&&i.updateMatrixWorld(),i.matrixWorld.decompose(R.position,R.quaternion,R.scale),i.matrixWorld.decompose(x.position,x.quaternion,x.scale);var M=this.scale;return R.translateOnAxis(l,M),x.translateOnAxis(u,M),s.getFrameData?(s.depthNear=i.near,s.depthFar=i.far,s.getFrameData(g),R.projectionMatrix.elements=g.leftProjectionMatrix,x.projectionMatrix.elements=g.rightProjectionMatrix):(R.projectionMatrix=a(f.fieldOfView,!0,i.near,i.far),x.projectionMatrix=a(w.fieldOfView,!0,i.near,i.far)),r?(r.viewport.set(h.x,h.y,h.width,h.height),r.scissor.set(h.x,h.y,h.width,h.height)):(e.setViewport(h.x,h.y,h.width,h.height),e.setScissor(h.x,h.y,h.width,h.height)),e.render(t,R,r,n),r?(r.viewport.set(d.x,d.y,d.width,d.height),r.scissor.set(d.x,d.y,d.width,d.height)):(e.setViewport(d.x,d.y,d.width,d.height),e.setScissor(d.x,d.y,d.width,d.height)),e.render(t,x,r,n),r?(r.viewport.set(0,0,E.width,E.height),r.scissor.set(0,0,E.width,E.height),r.scissorTest=!1,e.setRenderTarget(null)):(e.setViewport(0,0,E.width,E.height),e.setScissorTest(!1)),o&&(t.autoUpdate=!0),void(c.autoSubmitFrame&&c.submitFrame())}e.render(t,i,r,n)},this.dispose=function(){window.removeEventListener("vrdisplaypresentchange",i,!1)}};